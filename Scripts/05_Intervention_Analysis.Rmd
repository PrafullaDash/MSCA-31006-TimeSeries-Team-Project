---
title: "Intervention_Analysis"
author: "Prafulla Ranjan Dash"
output: html_document
---
#### Here, we try and apply Intervention Analysis for the number of views time-series for the *2016_FIFA_Club_World_Cup_en* webpage.

```{r workdirimp, echo=TRUE, message=FALSE, warning=FALSE}
# basic imports
library("fpp", lib.loc="C:/Users/HP/Anaconda3/envs/rstudio/lib/R/library")
library("ggplot2", lib.loc="C:/Users/HP/Anaconda3/envs/rstudio/lib/R/library")
library("stats", lib.loc="C:/Users/HP/Anaconda3/envs/rstudio/lib/R/library")
library("zoo", lib.loc="C:/Users/HP/Anaconda3/envs/rstudio/lib/R/library")
library("TSA", lib.loc="C:/Users/HP/Anaconda3/envs/rstudio/lib/R/library")
```

#### Importing the data

```{r dataimport, echo=TRUE, message=FALSE, warning=FALSE}
setwd("D:/USMS/UChicago/STUDIES/Autumn 2020/MSCA 31006 1 Time Series Analysis and Forecasting/Final Project/Data")
page_2016_FIFA_Club_World_Cup_views <- data.matrix(read.csv("train_1.csv", header = TRUE, row.names = 1,sep = ",",nrows = 1,skip = 8393))
```

#### Preparing data to make it ready for time-series

```{r dataprepare, echo=TRUE, message=FALSE, warning=FALSE}
# removing column names
dimnames(page_2016_FIFA_Club_World_Cup_views) <- NULL

# converting to array
page_2016_FIFA_Club_World_Cup_views <- array(page_2016_FIFA_Club_World_Cup_views)

# checking the values
head(page_2016_FIFA_Club_World_Cup_views)

# no. of ovservations
length(page_2016_FIFA_Club_World_Cup_views)
```

Looking at the entire data - 

```{r view, echo=TRUE, message=FALSE, warning=FALSE}
plot(page_2016_FIFA_Club_World_Cup_views,type = 'l')
```

Looking at this dataset, we can see there are few time periods where there seems to be an intervention. So, we will focus on one such intervention for our analysis. For this, let us split our data.

```{r split, echo=TRUE, message=FALSE, warning=FALSE}
# splitting to train and test
page_2016_FIFA_Club_World_Cup_views <- page_2016_FIFA_Club_World_Cup_views[1:350]

# converting data to ts
page_2016_FIFA_Club_World_Cup_views <- ts(page_2016_FIFA_Club_World_Cup_views,frequency = 1)

# plotting the time-series
autoplot(page_2016_FIFA_Club_World_Cup_views)
```

So, here we can clearly see some sort of **intervention** that took place at around the time-period of 200 days. There is a clear **upward trend** after the time-period of 200 days. We can also argue that there was another intervention prior to this, but I think this intervention is not that significant in comparision to the one at time period 200. This looks more like a pulse function.Hence we will handle those points as outliers and replace them with the mean of the data.

Now, since the intervention is at time-period 200, we will divide our data into data-points prior to time-period 200 and post time-period 200. We will do this so that we can find the **underlying process** that is present in our observations, which are a **mix of the underlying process and the intervention**.


```{r split2, echo=TRUE, message=FALSE, warning=FALSE}
# splitting
page_2016_FIFA_Club_World_Cup_views_prior <- page_2016_FIFA_Club_World_Cup_views[1:200]
page_2016_FIFA_Club_World_Cup_views_post <- page_2016_FIFA_Club_World_Cup_views[201:350]

# converting to time-series
page_2016_FIFA_Club_World_Cup_views_prior <- ts(page_2016_FIFA_Club_World_Cup_views_prior,frequency = 1)
page_2016_FIFA_Club_World_Cup_views_post <- ts(page_2016_FIFA_Club_World_Cup_views_post,frequency = 1)
```

Now, let's see how our prior intervention data looks

```{r prior, echo=TRUE, message=FALSE, warning=FALSE}
autoplot(page_2016_FIFA_Club_World_Cup_views_prior)
```

From the look of it, as we discussed earlier, let's first treat the 'outliers'.

```{r prioroutliers, echo=TRUE, message=FALSE, warning=FALSE}
# replacing the outlier with mean
page_2016_FIFA_Club_World_Cup_views_prior[page_2016_FIFA_Club_World_Cup_views_prior>1000] <- mean(page_2016_FIFA_Club_World_Cup_views_prior[!page_2016_FIFA_Club_World_Cup_views_prior>1000])

# plotting
autoplot(page_2016_FIFA_Club_World_Cup_views_prior)
```

Looking at the data - 

1. There is no visible non-seasonal trend.  
2. There might be some seasonality where some patterns are repeating themselves.
3. The variance seems unstable, might require some Box-Cox transformation.

Applying Box-Cox - 

```{r boxcox, echo=TRUE, message=FALSE, warning=FALSE}
BoxCox.lambda(page_2016_FIFA_Club_World_Cup_views_prior)

page_2016_FIFA_Club_World_Cup_views_prior_transformed <- BoxCox(page_2016_FIFA_Club_World_Cup_views_prior,lambda = -0.455303)

autoplot(page_2016_FIFA_Club_World_Cup_views_prior_transformed)
```

The variance now seems to have stabilized a bit. Now, let's look at the ACF and PACF for this signal.

```{r acf, echo=TRUE, message=FALSE, warning=FALSE}
tsdisplay(page_2016_FIFA_Club_World_Cup_views_prior_transformed)
```

We can see from the ACF that our data is **not stationary** as there are significant spikes along with a sinusoidal component. Let's apply one order of non-seasonal differencing.

```{r diff, echo=TRUE, message=FALSE, warning=FALSE}
# differencing
page_2016_FIFA_Club_World_Cup_views_prior_transformed_diff <- diff(page_2016_FIFA_Club_World_Cup_views_prior_transformed,lag = 2)

# visulalizing
tsdisplay(page_2016_FIFA_Club_World_Cup_views_prior_transformed_diff)
```

We see that the data still does not appear stationary. Let's confirm this with KPSS test - 

```{r kpss1, echo=TRUE, message=FALSE, warning=FALSE}
auto.arima(page_2016_FIFA_Club_World_Cup_views_prior, lambda = 'auto', seasonal = TRUE, stationary = FALSE)
```

```{r model, echo=TRUE, message=FALSE, warning=FALSE}
m1 <- arimax(page_2016_FIFA_Club_World_Cup_views,order = c(0,1,3),xreg = data.frame(x=c(rep(0,200),1:150)))
m1
exp_intervention=c()
for (x in 1:150) {
exp_intervention <- append(exp_intervention,exp(x))
}
exp_intervention <- ts(exp_intervention)
m2 <- arimax(page_2016_FIFA_Club_World_Cup_views,order = c(0,1,3),
             xreg =data.frame(x=c(rep(0,200),Model.ets$fitted[201:350])))
m2
m3 <- arimax(page_2016_FIFA_Club_World_Cup_views,order = c(0,1,3),
             xreg =Model.ets$fitted)
m3
```

```{r model11, echo=TRUE, message=FALSE, warning=FALSE}
autoplot(Model.ets<-ets(page_2016_FIFA_Club_World_Cup_views))
Model.ets$fitted[200:350]
```

```{r diag, echo=TRUE, message=FALSE, warning=FALSE}
checkresiduals(m1)
checkresiduals(m2)
checkresiduals(m3)
```